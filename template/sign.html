{{define "sign" }}
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>StringNote</title>
  <link rel="icon" href="/static/favicon.ico">
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.3.0/firebase-ui-auth.css" />
  <link type="text/css" rel="stylesheet" href="/static/sign.css" />
</head>

<body>
  <h1>Welcome to StringNote.</h1>
  <span class="topic">early access version. (since 2020/09/01)</span><br/>
  total access: <span id="access">{{.Acc}}</span><br/>
  <span class="topic">[NEW!]</span>referenced viewer (HTML-API): <a href="/static/view.html" target="viewer">version 1</a><br/>
  <span class="topic">[NEW!]</span>referenced viewer (JSON-API): <a href="/static/view2.html" target="viewer">version 2</a><br/>
  <span class="topic">[NEW!]</span>source code: <a href="https://github.com/StringNote/strnote">GitHub</a><br/>
  <div id="update" class="hide">
    <div id="note-disp">
      <span id="userlink"></span><br/>
      <iframe id="usernote"></iframe><br/>
    </div>
    <div id="note-id">
      your ID:<br/>
      <span id="userid"></span><br/>
      your note embedded:<br/>
      <span id="usertag"></span><br/>
    </div>
    <div id="note-update">
      nickname:<br/>
      <input type="text" id="note-name" autocomplete="on"></input><br/>
      message:<br/>
      <textarea id="note-mes" autocomplete="on"></textarea><br/>
      <div id="btn-update-div" class="button-align">
        <button type="button" id="btn-update" class="stdbutton">Update note.</button>
      </div>
    </div>
  </div>
  <div class="ad">This space is reserved for<br/>sponsored &amp; advertising.</div>
  <div id="cage"><div id="firebaseui-auth-container"></div></div>
  <div id="logout" class="hide button-align">
    <button type="button" id="btn-logout" class="stdbutton">Logout from Account.</button>
  </div>
  <hr/>
  copyright: strnote.com [<a href="mailto:contact@strnote.com" target="mail">mail</a>]<br/>
  ・<a href="/static/privacy.html" target="privacy">Privacy Policy</a><br/>
  <p>
    <iframe src="https://strnote.com/api/v1/4B_4CSj0U_nhWa6YCbzB1w" style="border: 0px; width: 750px; height: 32em;"></iframe><br/>
    <a href="https://strnote.com/api/v1/4B_4CSj0U_nhWa6YCbzB1w" target="notif">Open this note in a separate window.</a>
  </p>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
  <!-- Add SDKs for Firebase products that you want to use
	 https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/4.3.0/firebase-ui-auth__ja.js"></script>
  <script src="static/config.js"></script>
  <script src="static/send.js"></script>
  <script>
    //----------------------------------------------
    // Firebase UIの設定
    //----------------------------------------------
    var uiConfig = {
      callbacks: {
        signInSuccessWithAuthResult: function (authResult, redirectUrl) {
          return true;
        },
        uiShown: function () {
          // document.getElementById('loader').style.display = 'none';
        }
      },
      // ログイン完了時のリダイレクト先
      signInFlow: 'popup',
      signInSuccessUrl: '/',

      // 利用する認証機能
      signInOptions: [
        firebase.auth.GoogleAuthProvider.PROVIDER_ID
        // , firebase.auth.FacebookAuthProvider.PROVIDER_ID
        , firebase.auth.TwitterAuthProvider.PROVIDER_ID
        , firebase.auth.GithubAuthProvider.PROVIDER_ID
      ]
    };

    var idToken = "";

    //----------------------------------------------
    // ログイン状態のチェック
    //----------------------------------------------
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        // ログイン済み
        idToken = "";
        // IDトークンを取得
        firebase.auth().currentUser.getIdToken(true)
        .then(function (token) {
          idToken = token;
          showUpdate();
          // アクセス用のIDを得る
          sendTokenPromise(idToken, "", "")
            .then(function (info, result) {
              console.log(info.result);
              res = JSON.parse(info.result)
              replaceIframe(res.uid);
              setNote(res.name, res.mes);
            }).catch(function (error) {
              console.log(error);
            });
        }).catch(function (error) {
          console.log(error);
        });
        showLogout();
        console.log(user);
      } else {
        // ログインしていない
        showLogin();
        hideUpdate();
        // Firebase Auth 開始
        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        ui.start('#firebaseui-auth-container', uiConfig);
      }
    });

    //----------------------------------------------
    // ログアウト
    //----------------------------------------------
    document.querySelector('#btn-logout').addEventListener("click", () => {
      firebase.auth().signOut().then(() => {
        showLogin();
      }).catch((error) => {
        alert(`ログアウトできませんでした(${error})`);
      });
    });

    //----------------------------------------------
    // 更新
    //----------------------------------------------
    document.querySelector('#btn-update').addEventListener("click", () => {
      name = document.getElementById("note-name").value
      mes = document.getElementById("note-mes").value
      sendTokenPromise(idToken, name, mes)
        .then(function (info, result) {
          console.log(info.result);
          res = JSON.parse(info.result)
          replaceIframe(res.uid);
          setNote(res.name, res.mes);
        }).catch(function (error) {
          console.log(error);
        });
    });

    function showLogin() {
      document.getElementById('logout').classList.add("hide");
      hideUpdate();
    }
    function showLogout() {
      document.getElementById('logout').classList.remove("hide");
    }

    function replaceIframe(id) {
      var html = "<iframe src=\"/api/v1/" + id + "\"></iframe>";
      var url = "https://strnote.com/api/v1/" + id;
      document.getElementById('userid').innerHTML = "<code>"+id+"</code>";
      document.getElementById('userlink').innerHTML = "<a href=\""+url+"\" target=\"_new\">your note URL</a>";
      document.getElementById('usertag').innerHTML = "&lt;iframe src=\"" + url + "\"&gt;&lt;/iframe&gt;";
      document.getElementById('usernote').outerHTML = "<iframe id=\"usernote\" src=\"" + url + "\"></iframe>";
      //document.getElementById('usernote').contentDocument.location.replace(url);
    }
    function setNote(name, mes) {
      document.getElementById('note-name').value = name;
      document.getElementById('note-mes').textContent = mes;
    }
    function showUpdate() {
      document.getElementById('update').classList.remove("hide");
    }
    function hideUpdate() {
      document.getElementById('update').classList.add("hide");
    }
  </script>
</body>

</html>
{{end}}
